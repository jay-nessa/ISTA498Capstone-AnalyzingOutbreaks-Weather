---
title: "Analysis & Machine Learning - General Look at Environmental Factors"
author: "Janessa Davis - University of Arizona"
date: "`r Sys.Date()`"
output:
  bookdown::pdf_document2:
    latex_engine: lualatex
  tufte::tufte_handout:
    latex_engine: xelatex
---
```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r, include=FALSE}
# pulling in the datasets 
library(tidyverse)
library(lubridate)
library(dbscan)
library(factoextra)
cdc <- read_csv('cdcnors_midwest_2001-2021.csv')
illinois <- read_csv('illinois_weather.csv')
iowa <- read_csv('iowa_weather.csv')
wisconsin <- read_csv('wisconsin_weather.csv')
```

```{r Cleaning and Prepping the Data for Plotting and Merging, include=FALSE}
# taking a look at the data 
head(cdc)
head(illinois)
head(iowa)
head(wisconsin)
# making the heads lowercase for easier coding 
colnames(illinois) <- tolower(colnames(illinois))
colnames(iowa) <- tolower(colnames(iowa))
colnames(wisconsin) <- tolower(colnames(wisconsin))

# splitting the date into individual columns so that the data can be round up on a monthly and yearly basis 
illinois <- illinois |> 
  mutate(lubridate::year(date), lubridate::month(date), lubridate::day(date))

iowa <- iowa |> 
  mutate(lubridate::year(date), lubridate::month(date), lubridate::day(date))

wisconsin <- wisconsin |> 
  mutate(lubridate::year(date), lubridate::month(date), lubridate::day(date))

colnames(illinois)[8:10] <- c('year', 'month', 'week')
colnames(iowa)[8:10] <- c('year', 'month', 'week')
colnames(wisconsin)[8:10] <- c('year', 'month', 'week')

# dropping the original date column 
iowa <- iowa[,-1]; illinois <- illinois[, -1]; wisconsin <- wisconsin[, -1]
# reordering the columns 
illinois <- illinois[,c(7:9,1:6)]; iowa <- iowa[,c(7:9,1:6)]; wisconsin <- wisconsin[,c(7:9,1:6)]
# dropping the week number column 
illinois <- illinois[, -3]; iowa <- iowa[, -3]; wisconsin <- wisconsin[, -3]

# adding a column for the state to be combined with the CDC data 
wisconsin_state <- rep('Wisconsin', nrow(wisconsin))
illinois_state <- rep('Illinois', nrow(illinois))
iowa_state <- rep('Iowa', nrow(iowa))

wisconsin$state <- wisconsin_state
illinois$state <- illinois_state
iowa$state <- iowa_state

colnames(illinois) <- c('year', 'month', 'tavg', 'tmax', 'tmin', 'prcp', 'snow', 'snwdepth', 'state')
colnames(iowa) <- c('year', 'month', 'tavg', 'tmax', 'tmin', 'prcp', 'snow', 'snwdepth', 'state')
colnames(wisconsin) <- c('year', 'month', 'tavg', 'tmax', 'tmin', 'prcp', 'snow', 'snwdepth', 'state')

```

```{r, include = FALSE}
head(cdc)
head(illinois)
head(iowa)
head(wisconsin)

summary(cdc)
summary(illinois)
summary(iowa)
summary(wisconsin)

# all weather data 
weather <- rbind(illinois, wisconsin, iowa)
head(weather)

```

```{r, echo=FALSE}
# taking a look at the distribution of outbreaks for each state 
cdc |> 
  ggplot(aes(x=state,
             y=illnesses)) +
  geom_boxplot() + labs(title='Distribution of Illnesses for Each State', y='Number of Illnesses') # MAJOR outliers with the number of illnesses 

cdc |> 
  filter(illnesses <= 500) |>
  ggplot(aes(x=state,
             y=illnesses)) +
  geom_boxplot() + labs(title='Distribution of Illnesses less than 500 for Each State', y='Number of Illnesses') # still MAJOR outliers with the number of illnesses 

# seeing the number of illnesses for each mode type 
cdc |> 
  ggplot(aes(x=illnesses,
             y=hospitalizations)) +
  geom_point()+ 
  facet_wrap(~primary.mode) + labs(title='Relationship with Number of Illnesses and Hospitalizations', x='Number of Illnesses', y='Number of Hospitalizations')

# graphing the illness against year 
cdc |> 
  ggplot(aes(x = as.factor(year), 
             y = illnesses)) + 
  geom_boxplot() + labs(title='Distribution of Illnesses by Year',x='Year',y='Number of Illnesses')

cdc |> 
  filter(illnesses <= 100) |> 
  ggplot(aes(x = as.factor(year), 
             y = illnesses)) + 
  geom_boxplot() + labs(title='Distribution of Illnesses less than 100 by Year', x='Year', y='Number of Illnesses')

cdc |> 
  filter(illnesses <= 100) |> 
  ggplot(aes(x = as.factor(year), 
             y = illnesses)) + 
  geom_boxplot() +
  facet_wrap(~primary.mode) + labs(title='Distribution of Illnesses Each Year for Primary Mode of Outbreak',x='Year', y='Number of Illnesses')

cdc |> 
  filter(illnesses <= 100) |> 
  ggplot(aes(x=primary.mode, 
             y = illnesses)) + 
  geom_boxplot() + labs(title='Distribution of Illnesses for Primary Outbreak Mode', x='Primary Mode', y='Number of Illnesses')

cdc |> 
  filter(illnesses <= 100) |> 
  ggplot(aes(x=primary.mode, 
             y = year)) + 
  geom_boxplot() + labs(title='Distribution of Years for Each Primary Outbreak Mode', x='Primary Mode', y='Year')

cdc |> 
  ggplot(aes(x = as.factor(month), 
             y = illnesses)) + 
  geom_col() + 
  facet_wrap(~primary.mode) + labs(title='Number of Illnesses by Month for Each Primary Outbreak Mode', x='Month', y='Number of Illnesses')
# interesting that the colder months have higher counts of outbreaks for person to person but July and Aug are the primary months for water outbreaks 

cdc |> 
  filter(etiology %in% c('salmonella', 'e. coli', 'clostriduim')) |>
  filter (illnesses <= 500) |>
  ggplot(aes(x = year, 
             y = illnesses)) + 
  geom_col() + facet_wrap(~etiology) + labs(title='Number of Illnesses by Month for Each Primary Outbreak Mode', x='Month', y='Number of Illnesses')

  
```


```{r, include=FALSE}
# taking a look at the correlations between variables 
cor(illinois[,-9])
cor(wisconsin[,-9])
cor(iowa[,-9])

# creating a combined dataframe with the cdc and weather data 
# will need to roll up to the month, year, and state with summary of weather data and the number of illnesses 
total.illnesses <- cdc |> 
  group_by(year, month, state) |> 
  summarise(total.illnesses = sum(illnesses)) 
avg.weather <- weather |> 
  group_by(year, month, state) |> 
  summarise(avg.meantemp = mean(tavg),
            avg.maxtemp = mean(tmax),
            avg.mintemp = mean(tmin),
            avg.prcp = mean(prcp),
            avg.snow = mean(snow),
            avg.snowdepth = mean(snwdepth))
avg.weather
# joining the two dataset together 
cdc.weather <- total.illnesses |> full_join(avg.weather, by = c('year' = 'year',
                                                 'month' = 'month',
                                                 'state' = 'state'))
cdc.weather <- cdc.weather |> filter(total.illnesses <= 500)

head(cdc.weather)
```

```{r, echo = FALSE}
# plotting the number of illnesses against each of the different weather values to find any notable patterns 
cdc.weather |> ggplot(aes(x=avg.meantemp, y=total.illnesses, color = state)) + geom_point() + labs(title='Number of Illnesses vs. Average Mean Temperature by State', x='Average Mean Temp (˚F)', y='Number of Illnesses', color='State')
cdc.weather |> ggplot(aes(x=total.illnesses, y=avg.maxtemp, color = state)) + geom_point() + labs(title='Number of Illnesses vs. Average Max Temperature by State', x='Number of Illnesses', y='Average Max Temp (˚F)', color='State')
cdc.weather |> ggplot(aes(x=total.illnesses, y=avg.mintemp, color = state)) + geom_point() + labs(title='Number of Illnesses vs. Average Minimum Temperature by State', x='Number of Illnesses', y='Average Min Temp (˚F)', color='State')
cdc.weather |> ggplot(aes(x=total.illnesses, y=avg.prcp, color = state)) + geom_point() + labs(title='Number of Illnesses vs. Average Precipitation in Inches by State', x='Number of Illnesses', y='Average Precipitation (in)', color='State')
cdc.weather |> ggplot(aes(x=total.illnesses, y=avg.snow, color = state)) + geom_point() + labs(title='Number of Illnesses vs. Average Snowfall in Inches by State', x='Number of Illnesses', y='Average Snowfall (in)', color='State')
cdc.weather |> ggplot(aes(x=total.illnesses, y=avg.snowdepth, color = state)) + geom_point() + labs(title='Number of Illnesses vs. Average Snow Depth in Inches by State', x='Number of Illnesses', y='Average Snow Depth (in)', color='State')

cdc.weather |> filter(total.illnesses <= 100) |> ggplot(aes(x=total.illnesses, y=avg.meantemp, color = state)) + geom_point() + labs(title='Number of Illnesses less than 100 vs. Average Mean Temperature by State', x='Number of Illnesses', y='Average Mean Temp (˚F)', color='State')
cdc.weather |> filter(total.illnesses <= 100) |> ggplot(aes(x=total.illnesses, y=avg.maxtemp, color = state)) + geom_point() + labs(title='Number of Illnesses less than 100 vs. Average Max Temperature by State', x='Number of Illnesses', y='Average Max Temp (˚F)', color='State')
cdc.weather |> filter(total.illnesses <= 100) |> ggplot(aes(x=total.illnesses, y=avg.mintemp, color = state)) + geom_point() + labs(title='Number of Illnesses less than 100 vs. Average Minimum Temperature by State', x='Number of Illnesses', y='Average Min Temp (˚F)', color='State')
cdc.weather |> filter(total.illnesses <= 100) |> ggplot(aes(x=total.illnesses, y=avg.prcp, color = state)) + geom_point() + labs(title='Number of Illnesses less than 100 vs. Average Precipitation in Inches by State', x='Number of Illnesses', y='Average Precipitation (in)', color='State')
cdc.weather |> filter(total.illnesses <= 100) |> ggplot(aes(x=total.illnesses, y=avg.snow, color = state)) + geom_point() + labs(title='Number of Illnesses less than 100 vs. Average Snowfall in Inches by State', x='Number of Illnesses', y='Average Snowfall (in)', color='State')
cdc.weather |> filter(total.illnesses <= 100) |> ggplot(aes(x=total.illnesses, y=avg.snowdepth, color = state)) + geom_point() + labs(title='Number of Illnesses less than 100 vs. Average Snow Depth in Inches by State', x='Number of Illnesses', y='Average Snow Depth (in)', color='State')
# boxplot of months and illnesses
cdc.weather |> ggplot(aes(x=as.factor(month), y=total.illnesses)) + geom_boxplot() + facet_wrap(~state) + labs(title='Distribution of Number of Illnesses by Month for Each State', x='Month', y='Number of Illnesses')
```



# Simple Linear Regression 
```{r, inlcude=FALSE}
# running a linear regression to see which of the variables are significant 
lm.full <- lm(total.illnesses ~ ., data=cdc.weather)
summary(lm.full)
lm.reduced1 <- lm(total.illnesses ~ state + avg.meantemp, data = cdc.weather)
summary(lm.reduced1)
lm.reduced2 <- lm(total.illnesses ~ state + avg.prcp, data = cdc.weather)
summary(lm.reduced2)
lm.reduced3 <- lm(total.illnesses ~ state + avg.mintemp + avg.prcp, data = cdc.weather)
summary(lm.reduced3)

```

# K-Mean Clustering for each of the Weather Predictors and Number of Illnesses
```{r, echo=FALSE}
# applying clustering methods 
# applying k-mean clustering using the elbow technique to find the best k value 
# scaling the data 
scaled.cdc.weather <- cbind(cdc.weather[,1:3], scale(cdc.weather[,-c(1:3)]))
glimpse(scaled.cdc.weather)
scaled.meantemp <- scaled.cdc.weather[, c('total.illnesses', 'avg.meantemp')]
scaled.meantemp <- na.omit(scaled.meantemp)
glimpse(scaled.meantemp)
# applying k-mean clustering with k = 5 to the mean temperature 
scaled.kmeans1 <- kmeans(scaled.meantemp, centers = 5, nstart = 20)
kmeans1.clusters <- factor(scaled.kmeans1$cluster)
scaled.meantemp$clusters <- kmeans1.clusters

ggplot(scaled.meantemp, aes(x = total.illnesses, y = avg.meantemp, color = clusters)) + geom_point() + labs(title='K=5 K-Means Clustering of Total Illnesses vs. Average Mean Temperature', x='Number of Illnesses', y='Average Mean Temperature (˚F)')
print(scaled.kmeans1$withinss) # fairly high clustering variances so going to use elbow method to figure out the best k value for the data that minimizes the variance of the data set 

# applying the elbow method to determine the best k value 
meantemp_kmeans <- data.frame(matrix(ncol = 2, nrow = 15))
colnames(meantemp_kmeans) <- c('k', 'wi_ss')
for(i in 1:15){ #running from k = 1 to k = 15
  km <- kmeans(scaled.meantemp, centers = i)
  wi_ss <- round(km$tot.withinss, 3)
  meantemp_kmeans[i, 'k'] <- i
  meantemp_kmeans[i, 'wi_ss'] <- wi_ss
}
meantemp_kmeans |> ggplot(aes(x=k, y=wi_ss)) + geom_line() + geom_point() + labs(title='K-Means Clustering Elbow Method for Number of Illnesses vs. Average Mean Temperature', y='Within Sum of Squares') # k = 14 seems to yield the lowest sum of squares values 

# applying k-mean clustering with k = 5 to the mean temperature 
scaled.kmeans1 <- kmeans(scaled.meantemp, centers = 14, nstart = 20)
kmeans1.clusters <- factor(scaled.kmeans1$cluster)
scaled.meantemp$clusters <- kmeans1.clusters

ggplot(scaled.meantemp, aes(x = total.illnesses, y = avg.meantemp, color = clusters)) + geom_point() + labs(title='K=14 K-Means Clustering of Total Illnesses vs. Average Mean Temperature', x='Scaled Number of Illnesses', y='Scaled Average Mean Temperature (˚F)')
```

```{r, echo=FALSE}
# applying k means clustering to precipitation, snow, snowdepth to see if weather anamolies cause patterns with the number of illnesses seen with an outbreak 

# applying the kmeans elbow method to the precipitation variable 
scaled.prcp <- scaled.cdc.weather[, c('total.illnesses', 'avg.prcp')]
scaled.prcp <- na.omit(scaled.prcp)
glimpse(scaled.prcp)

prcp_kmeans <- data.frame(matrix(ncol = 2, nrow = 20))
colnames(prcp_kmeans) <- c('k', 'wi_ss')
for(i in 1:20){ #running from k = 1 to k = 20
  km <- kmeans(scaled.prcp, centers = i)
  wi_ss <- round(km$tot.withinss, 3)
  prcp_kmeans[i, 'k'] <- i
  prcp_kmeans[i, 'wi_ss'] <- wi_ss
}
prcp_kmeans |> ggplot(aes(x=k, y=wi_ss)) + geom_line() + geom_point() + labs(title='K-Means Clustering Elbow Method for Number of Illnesses vs. Average Precipitation', y='Within Sum of Squares')

scaled.kmeans2 <- kmeans(scaled.prcp, centers = 17)
kmeans2.clusters <- factor(scaled.kmeans2$cluster)
scaled.prcp$clusters <- kmeans2.clusters

ggplot(scaled.prcp, aes(x = total.illnesses, y = avg.prcp, color = clusters)) + geom_point() + labs(title='K=17 K-Means Clustering of Total Illnesses vs. Average Precipitation ', x='Scaled Number of Illnesses', y='Scaled Precipitation (in)')

```

```{r, echo=FALSE}
# applying the kmeans elbow method to the max temp variable 
scaled.maxtemp <- scaled.cdc.weather[, c('total.illnesses', 'avg.maxtemp')]
scaled.maxtemp <- na.omit(scaled.maxtemp)
#glimpse(scaled.maxtemp)

maxtemp_kmeans <- data.frame(matrix(ncol = 2, nrow = 20))
colnames(maxtemp_kmeans) <- c('k', 'wi_ss')
for(i in 1:15){ #running from k = 1 to k = 15
  km <- kmeans(scaled.maxtemp, centers = i)
  wi_ss <- round(km$tot.withinss, 3)
  maxtemp_kmeans[i, 'k'] <- i
  maxtemp_kmeans[i, 'wi_ss'] <- wi_ss
}
maxtemp_kmeans |> ggplot(aes(x=k, y=wi_ss)) + geom_line() + geom_point() + labs(title='K-Means Clustering Elbow Method for Number of Illnesses vs. Average Maximum Temperature', y='Within Sum of Squares')

scaled.kmeans3 <- kmeans(scaled.maxtemp, centers = 14)
kmeans3.clusters <- factor(scaled.kmeans3$cluster)
scaled.maxtemp$clusters <- kmeans3.clusters

ggplot(scaled.maxtemp, aes(x = total.illnesses, y = avg.maxtemp, color = clusters)) + geom_point() + labs(title='K=14 K-Means Clustering of Total Illnesses vs. Average Maximum Temperature ', x='Scaled Number of Illnesses', y='Scaled Average Maximum Temperature (˚F)')

```

```{r, echo=FALSE}
# applying the kmeans elbow method to the min temp variable 
scaled.mintmep <- scaled.cdc.weather[, c('total.illnesses', 'avg.mintemp')]
scaled.mintmep <- na.omit(scaled.mintmep)
#glimpse(scaled.mintmep)

mintemp_kmeans <- data.frame(matrix(ncol = 2, nrow = 20))
colnames(mintemp_kmeans) <- c('k', 'wi_ss')
for(i in 1:15){ #running from k = 1 to k = 15
  km <- kmeans(scaled.mintmep, centers = i)
  wi_ss <- round(km$tot.withinss, 3)
  mintemp_kmeans[i, 'k'] <- i
  mintemp_kmeans[i, 'wi_ss'] <- wi_ss
}
mintemp_kmeans |> ggplot(aes(x=k, y=wi_ss)) + geom_line() + geom_point() + labs(title='K-Means Clustering Elbow Method for Number of Illnesses vs. Average Minimum Temperature', y='Within Sum of Squares')  # 14 clusters seems to offer the lowest total sum of squares

scaled.kmeans4 <- kmeans(scaled.mintmep, centers = 14)
kmeans4.clusters <- factor(scaled.kmeans4$cluster)
scaled.mintmep$clusters <- kmeans4.clusters

ggplot(scaled.mintmep, aes(x = total.illnesses, y = avg.mintemp, color = clusters)) + geom_point() + labs(title='K=14 K-Means Clustering of Total Illnesses vs. Average Minimum Temperature ', x='Scaled Number of Illnesses', y='Scaled Average Minimum Temperature (˚F)')

```

```{r, echo=FALSE}
# applying the kmeans elbow method to the snow variable 
scaled.snow <- scaled.cdc.weather[, c('total.illnesses', 'avg.snow')]
scaled.snow <- na.omit(scaled.snow)
#glimpse(scaled.snow)

snow_kmeans <- data.frame(matrix(ncol = 2, nrow = 20))
colnames(prcp_kmeans) <- c('k', 'wi_ss')
for(i in 1:20){ #running from k = 1 to k = 15
  km <- kmeans(scaled.snow, centers = i)
  wi_ss <- round(km$tot.withinss, 3)
  snow_kmeans[i, 'k'] <- i
  snow_kmeans[i, 'wi_ss'] <- wi_ss
}
snow_kmeans |> ggplot(aes(x=k, y=wi_ss)) + geom_line() + geom_point() + labs(title='K-Means Clustering Elbow Method for Number of Illnesses vs. Average Snowfall in Inches', y='Within Sum of Squares') # 18 clusters seems to offer the lowest total sum of squares 

scaled.kmeans5 <- kmeans(scaled.snow, centers = 18)
kmeans5.clusters <- factor(scaled.kmeans5$cluster)
scaled.snow$clusters <- kmeans5.clusters

ggplot(scaled.snow, aes(x = total.illnesses, y = avg.snow, color = clusters)) + geom_point() + labs(title='K=18 K-Means Clustering of Total Illnesses vs. Average Snowfall in Inches', x='Scaled Number of Illnesses', y='Scaled Average Snowfall (in)')

```

```{r, echo=FALSE}
# applying the kmeans elbow method to the snow depth variable 
scaled.snowdepth <- scaled.cdc.weather[, c('total.illnesses', 'avg.snowdepth')]
scaled.snowdepth <- na.omit(scaled.snowdepth)
#glimpse(scaled.snowdepth)

snowdepth_kmeans <- data.frame(matrix(ncol = 2, nrow = 20))
colnames(snowdepth_kmeans) <- c('k', 'wi_ss')
for(i in 1:20){ #running from k = 1 to k = 20
  km <- kmeans(scaled.snowdepth, centers = i)
  wi_ss <- round(km$tot.withinss, 3)
  snowdepth_kmeans[i, 'k'] <- i
  snowdepth_kmeans[i, 'wi_ss'] <- wi_ss
}
snowdepth_kmeans |> ggplot(aes(x=k, y=wi_ss)) + geom_line() + geom_point() + labs(title='K-Means Clustering Elbow Method for Number of Illnesses vs. Average Snow Depth in Inches', y='Within Sum of Squares') # 20 clusters offers the lowest total sum of squares value

scaled.kmeans6 <- kmeans(scaled.snowdepth, centers = 20)
kmeans6.clusters <- factor(scaled.kmeans6$cluster)
scaled.snowdepth$clusters <- kmeans6.clusters

ggplot(scaled.snowdepth, aes(x = total.illnesses, y = avg.snowdepth, color = clusters)) + geom_point() + labs(title='K=20 K-Means Clustering of Total Illnesses vs. Average Snow Depth in Inches', x='Scaled Number of Illnesses', y='Scaled Average Snow Depth (in)')

```



```{r, include=FALSE}
# pulling in the datasets 
library(tidyverse)
library(lubridate)
library(dbscan)
library(factoextra)
library(glmnet)
library(zoo)
cdc <- read_csv('cdcnors_midwest_2001-2021.csv')
illinois <- read_csv('illinois_weather.csv')
iowa <- read_csv('iowa_weather.csv')
wisconsin <- read_csv('wisconsin_weather.csv')
```

```{r Cleaning and Prepping the Data for Plotting and Merging 2, include=FALSE}
# taking a look at the data 
head(cdc)
head(illinois)
head(iowa)
head(wisconsin)
# making the heads lowercase for easier coding 
colnames(illinois) <- tolower(colnames(illinois))
colnames(iowa) <- tolower(colnames(iowa))
colnames(wisconsin) <- tolower(colnames(wisconsin))

# splitting the date into individual columns so that the data can be round up on a monthly and yearly basis 
illinois <- illinois |> 
  mutate(lubridate::year(date), lubridate::month(date), lubridate::day(date))

iowa <- iowa |> 
  mutate(lubridate::year(date), lubridate::month(date), lubridate::day(date))

wisconsin <- wisconsin |> 
  mutate(lubridate::year(date), lubridate::month(date), lubridate::day(date))

colnames(illinois)[8:10] <- c('year', 'month', 'week')
colnames(iowa)[8:10] <- c('year', 'month', 'week')
colnames(wisconsin)[8:10] <- c('year', 'month', 'week')

# dropping the original date column 
iowa <- iowa[,-1]; illinois <- illinois[, -1]; wisconsin <- wisconsin[, -1]
# reordering the columns 
illinois <- illinois[,c(7:9,1:6)]; iowa <- iowa[,c(7:9,1:6)]; wisconsin <- wisconsin[,c(7:9,1:6)]
# dropping the week number column 
illinois <- illinois[, -3]; iowa <- iowa[, -3]; wisconsin <- wisconsin[, -3]

# adding a column for the state to be combined with the CDC data 
wisconsin_state <- rep('Wisconsin', nrow(wisconsin))
illinois_state <- rep('Illinois', nrow(illinois))
iowa_state <- rep('Iowa', nrow(iowa))

wisconsin$state <- wisconsin_state
illinois$state <- illinois_state
iowa$state <- iowa_state

colnames(illinois) <- c('year', 'month', 'tavg', 'tmax', 'tmin', 'prcp', 'snow', 'snwdepth', 'state')
colnames(iowa) <- c('year', 'month', 'tavg', 'tmax', 'tmin', 'prcp', 'snow', 'snwdepth', 'state')
colnames(wisconsin) <- c('year', 'month', 'tavg', 'tmax', 'tmin', 'prcp', 'snow', 'snwdepth', 'state')


# all weather data 
weather <- rbind(illinois, wisconsin, iowa)
glimpse(weather)

# adding a lag variable for the weather 
weather <- weather |> 
  mutate(lagged.tavg = lag(tavg, 1), 
         lagged.tmax = lag(tmax, 1), 
         lagged.tmin = lag(tmin, 1),
         lagged.prcp = lag(prcp, 1), 
         lagged.snow = lag(snow, 1),
         lagged.sdepth = lag(snwdepth, 1))
weather[1, 10:15] <- 0
head(weather)

# doing a merge of the full dataset 
total.illnesses <- cdc |> 
  group_by(year, month, state) |> 
  summarise(total.illnesses = sum(illnesses)) 
avg.weather <- weather |> 
  group_by(year, month, state) |> 
  summarise(avg.meantemp = mean(tavg),
            avg.maxtemp = mean(tmax),
            avg.mintemp = mean(tmin),
            avg.prcp = mean(prcp),
            avg.snow = mean(snow),
            avg.snowdepth = mean(snwdepth), 
            avg.lagmeantemp = mean(lagged.tavg),
            avg.lagmintemp = mean(lagged.tmin),
            avg.lagmaxtemp = mean(lagged.tmax), 
            avg.lagprcp = mean(lagged.prcp), 
            avg.lagsnow = mean(lagged.snow),
            avg.lagsdepth = mean(lagged.sdepth))
avg.weather
# joining the two dataset together 
cdc.weather <- total.illnesses |> full_join(avg.weather, by = c('year' = 'year',
                                                 'month' = 'month',
                                                 'state' = 'state'))
cdc.weather <- cdc.weather |> filter(total.illnesses <= 500)
head(cdc.weather)


```



# All CDC Outbreaks LASSO Regression Analysis
```{r, echo=FALSE}
# running LASSO regression on the entire dataset without a prior drill down 
# performing LASSO regression to determine which weather variables are possibly significant 
# filtering the data down to remove and handle NAs before perfomring LASSO regression 
set.seed(1)
cdc.filter <- cdc.weather |> filter(!is.na(total.illnesses))
# filling in the missing average temperature 
for (i in 1:nrow(cdc.filter)) { 
  if (is.na(cdc.filter$avg.meantemp[i]) == T) { 
    cdc.filter$avg.meantemp[i] = mean(cdc.filter$avg.maxtemp[i], cdc.filter$avg.mintemp[i])}
  if (is.na(cdc.filter$avg.lagmeantemp[i]) == T) { 
    cdc.filter$avg.lagmeantemp[i] = mean(cdc.filter$avg.lagmaxtemp[i], cdc.filter$avg.lagmintemp[i])}
  if (is.na(cdc.filter$avg.snow[i]) == T) { 
    cdc.filter$avg.snow[i] <- 0}
  if (is.na(cdc.filter$avg.lagsnow[i]) == T) { 
    cdc.filter$avg.lagsnow[i] <- 0}
  if (is.na(cdc.filter$avg.snowdepth[i]) == T) {
    cdc.filter$avg.snowdepth[i] <- 0}
  if (is.na(cdc.filter$avg.lagsdepth[i]) == T) {
    cdc.filter$avg.lagsdepth[i] <- 0}
}

write.csv(cdc.filter, 'cdc_weather.csv')

# creating the training and test sets 
test <- sample(1:nrow(cdc.filter), nrow(cdc.filter)/4) # taking a 1/4 of the data out for testing the model 
train <- (-test)
cdc.train.x <- as.matrix(cdc.filter[train, -4])
cdc.train.y <- as.matrix(cdc.filter[train, 'total.illnesses'])
cdc.test.x <- as.matrix(cdc.filter[test, -4])
cdc.test.y <- as.matrix(cdc.filter[test, 'total.illnesses'])

# applying the LASSO model to see which variables are significant 
cdc.lasso.mod <- glmnet(cdc.train.x, cdc.train.y, alpha = 1)
plot(cdc.lasso.mod)
# performing cross validation to compute test error and to perform variable selection 
cdc.cv <- cv.glmnet(cdc.train.x, cdc.train.y, alpha = 1)
plot(cdc.cv)
# getting the lambda value with the lowest MSE 
bestlam.cdc <- cdc.cv$lambda.min
cdc.lasso.pred <- predict(cdc.lasso.mod, s = bestlam.cdc, newx = cdc.test.x)
mean((cdc.lasso.pred - cdc.test.y)^2)
# looking at the LASSO coefficients to find the values coefficient values are 0 and thus not siginificant to the model prediction 
# fitting the LASSO regression using the best lambda value to determine variable selection 
cdc.filter <- as.matrix(cdc.filter)
full.cdc.lasso.mod <- glmnet(cdc.filter[,-4], cdc.filter[, 4], alpha = 1)
cdc.lasso.coef <- predict(full.cdc.lasso.mod, type = 'coefficients', s = bestlam.cdc)
cdc.lasso.coef
cdc.lasso.coef[cdc.lasso.coef != 0]

summary(cdc.cv)

```
Based on LASSO regression, significant variables for predicting the number of outbreaks/illnesses recorded are _year, month, mean temperature, max temperature, precipitation, snow, snow depth, and all the lag variables for the weather predictors_. 


```{r, include=FALSE}
# seeing which bacteria have the most outbreaks 
cdc |> group_by(etiology) |> summarise(tot.illnesess = sum(illnesses)) |> arrange(desc(tot.illnesess))
# the top etiologies that appear at salmonella, clostridium, shigella, cryptosporidium, and e.coli

# creating a weather dataframe for salmonella 
salmonella.illnesses <- cdc |> 
  filter(etiology == 'salmonella') |>
  group_by(year, month, state) |> 
  summarise(total.illnesses = sum(illnesses)) 
avg.weather <- weather |> 
  group_by(year, month, state) |> 
  summarise(avg.meantemp = mean(tavg),
            avg.maxtemp = mean(tmax),
            avg.mintemp = mean(tmin),
            avg.prcp = mean(prcp),
            avg.snow = mean(snow),
            avg.snowdepth = mean(snwdepth),
            avg.lagmeantemp = mean(lagged.tavg),
            avg.lagmintemp = mean(lagged.tmin),
            avg.lagmaxtemp = mean(lagged.tmax), 
            avg.lagprcp = mean(lagged.prcp), 
            avg.lagsnow = mean(lagged.snow),
            avg.lagsdepth = mean(lagged.sdepth))
# joining the two data set together 
salmonella.weather <- salmonella.illnesses |> full_join(avg.weather, by = c('year' = 'year',
                                                 'month' = 'month',
                                                 'state' = 'state'))
glimpse(salmonella.weather)

# creating a weather dataframe for clostridium 
clostriduim.illnesses <- cdc |> 
  filter(etiology == 'clostridium') |>
  group_by(year, month, state) |> 
  summarise(total.illnesses = sum(illnesses)) 
# joining the two dataset together 
clostriduim.weather <- clostriduim.illnesses |> full_join(avg.weather, by = c('year' = 'year',
                                                 'month' = 'month',
                                                 'state' = 'state'))
glimpse(clostriduim.weather)

# creating a weather dataframe for e. coli 
ecoli.illnesses <- cdc |> 
  filter(etiology == 'e. coli') |>
  group_by(year, month, state) |> 
  summarise(total.illnesses = sum(illnesses)) 
# joining the two dataset together 
ecoli.weather <- ecoli.illnesses |> full_join(avg.weather, by = c('year' = 'year',
                                                 'month' = 'month',
                                                 'state' = 'state'))
glimpse(ecoli.weather)

```

```{r, include=FALSE}
# performing linear regression for each to see if any weather factors are significant
# for entire dataset 
cdc.lm <- lm(total.illnesses ~ ., data = cdc.weather)
summary(cdc.lm)
# for salmonella 
salmonella.lm <- lm(total.illnesses ~ ., data = salmonella.weather)
summary(salmonella.lm)
# for clostridium
ecoli.lm <- lm(total.illnesses ~ ., data = ecoli.weather)
summary(ecoli.lm)
# for shigella
clostriduim.lm <- lm(total.illnesses ~ ., data = clostriduim.weather)
summary(clostriduim.lm)
```

# Salmonella LASSO Regression Analysis
```{r Salmonella LASSO, echo=FALSE}
# performing LASSO regression to determine which weather variables are possibly significant 
# filtering the data down to remove and handle NAs before perfomring LASSO regression 
set.seed(1)
salmonella.filter <- salmonella.weather |> filter(!is.na(total.illnesses))
# filling in the missing average temperature 
for (i in 1:nrow(salmonella.filter)) { 
  if (is.na(salmonella.filter$avg.meantemp[i]) == T) { 
    salmonella.filter$avg.meantemp[i] = mean(salmonella.filter$avg.maxtemp[i], salmonella.filter$avg.mintemp[i])}
  if (is.na(salmonella.filter$avg.lagmeantemp[i]) == T) { 
    salmonella.filter$avg.lagmeantemp[i] = mean(salmonella.filter$avg.lagmaxtemp[i], salmonella.filter$avg.lagmintemp[i])}
  if (is.na(salmonella.filter$avg.snow[i]) == T) { 
    salmonella.filter$avg.snow[i] <- 0}
  if (is.na(salmonella.filter$avg.lagsnow[i]) == T) { 
    salmonella.filter$avg.lagsnow[i] <- 0}
  if (is.na(salmonella.filter$avg.snowdepth[i]) == T) {
    salmonella.filter$avg.snowdepth[i] <- 0}
  if (is.na(salmonella.filter$avg.lagsdepth[i]) == T) {
    salmonella.filter$avg.lagsdepth[i] <- 0}
}

write.csv(salmonella.filter, 'salmonella_cdc_weather.csv')

# creating the training and test sets 
test <- sample(1:nrow(salmonella.filter), nrow(salmonella.filter)/4) # taking a 1/4 of the data out for testing the model 
train <- (-test)
salmonella.train.x <- as.matrix(salmonella.filter[train, -4])
salmonella.train.y <- as.matrix(salmonella.filter[train, 'total.illnesses'])
salmonella.test.x <- as.matrix(salmonella.filter[test, -4])
salmonella.test.y <- as.matrix(salmonella.filter[test, 'total.illnesses'])

# applying the LASSO model to see which variables are significant 
salmonella.lasso.mod <- glmnet(salmonella.train.x, salmonella.train.y, alpha = 1)
plot(salmonella.lasso.mod)
# performing cross validation to compute test error and to perform variable selection 
set.seed(1)
salmonella.cv <- cv.glmnet(salmonella.train.x, salmonella.train.y, alpha = 1)
plot(salmonella.cv)
# getting the lambda value with the lowest MSE 
bestlam <- salmonella.cv$lambda.min
salmonella.lasso.pred <- predict(salmonella.lasso.mod, s = bestlam, newx = salmonella.test.x)
mean((salmonella.lasso.pred - salmonella.test.y)^2)
# looking at the LASSO coefficients to find the values coefficient values are 0 and thus not significant to the model prediction 
# fitting the LASSO regression using the best lambda value to determine variable selection 
salmonella.filter <- as.matrix(salmonella.filter)
full.salmonella.lasso.mod <- glmnet(salmonella.filter[,-4], salmonella.filter[, 4], alpha = 1)
salmonella.lasso.coef <- predict(full.salmonella.lasso.mod, type = 'coefficients', s = bestlam)
salmonella.lasso.coef
salmonella.lasso.coef[salmonella.lasso.coef != 0]

```

# E. Coli LASSO Regression Analysis
```{r E. Coli LASSO, echo=FALSE}
# performing LASSO regression to determine which weather variables are possibly significant 
# filtering the data down to remove and handle NAs before perfomring LASSO regression 
set.seed(1)
ecoli.filter <- ecoli.weather |> filter(!is.na(total.illnesses))
# filling in the missing average temperature 
for (i in 1:nrow(ecoli.filter)) { 
  if (is.na(ecoli.filter$avg.meantemp[i]) == T) { 
    ecoli.filter$avg.meantemp[i] = mean(ecoli.filter$avg.maxtemp[i], ecoli.filter$avg.mintemp[i])}
  if (is.na(ecoli.filter$avg.lagmeantemp[i]) == T) { 
    ecoli.filter$avg.lagmeantemp[i] = mean(ecoli.filter$avg.lagmaxtemp[i], ecoli.filter$avg.lagmintemp[i])}
  if (is.na(ecoli.filter$avg.snow[i]) == T) { 
    ecoli.filter$avg.snow[i] <- 0}
  if (is.na(ecoli.filter$avg.lagsnow[i]) == T) { 
    ecoli.filter$avg.lagsnow[i] <- 0}
  if (is.na(ecoli.filter$avg.snowdepth[i]) == T) {
    ecoli.filter$avg.snowdepth[i] <- 0}
  if (is.na(ecoli.filter$avg.lagsdepth[i]) == T) {
    ecoli.filter$avg.lagsdepth[i] <- 0}
}
write.csv(ecoli.filter, 'ecoli_cdc_weather.csv')

# creating the training and test sets 
test <- sample(1:nrow(ecoli.filter), nrow(ecoli.filter)/4) # taking a 1/4 of the data out for testing the model 
train <- (-test)
ecoli.train.x <- as.matrix(ecoli.filter[train, -4])
ecoli.train.y <- as.matrix(ecoli.filter[train, 'total.illnesses'])
ecoli.test.x <- as.matrix(ecoli.filter[test, -4])
ecoli.test.y <- as.matrix(ecoli.filter[test, 'total.illnesses'])

# applying the LASSO model to see which variables are significant 
ecoli.lasso.mod <- glmnet(ecoli.train.x, ecoli.train.y, alpha = 1)
plot(ecoli.lasso.mod)
# performing cross validation to compute test error and to perform variable selection 
ecoli.cv <- cv.glmnet(ecoli.train.x, ecoli.train.y, alpha = 1)
plot(ecoli.cv)
# getting the lambda value with the lowest MSE 
bestlam2 <- ecoli.cv$lambda.min
ecoli.lasso.pred <- predict(ecoli.lasso.mod, s = bestlam2, newx = ecoli.test.x)
mean((ecoli.lasso.pred - ecoli.test.y)^2)
# looking at the LASSO coefficients to find the values coefficient values are 0 and thus not siginificant to the model prediction 
# fitting the LASSO regression using the best lambda value to determine variable selection 
ecoli.filter <- as.matrix(ecoli.filter)
full.ecoli.lasso.mod <- glmnet(ecoli.filter[,-4], ecoli.filter[, 4], alpha = 1)
ecoli.lasso.coef <- predict(full.ecoli.lasso.mod, type = 'coefficients', s = bestlam2)
ecoli.lasso.coef
ecoli.lasso.coef[ecoli.lasso.coef != 0]


```
# Clostriduim LASSO Regression Analysis
```{r Shigella LASSO, echo=FALSE}
# performing LASSO regression to determine which weather variables are possibly significant 
# filtering the data down to remove and handle NAs before perfomring LASSO regression 
set.seed(1)
clostriduim.filter <- clostriduim.weather |> filter(!is.na(total.illnesses))
# filling in the missing average temperature 
for (i in 1:nrow(clostriduim.filter)) { 
  if (is.na(clostriduim.filter$avg.meantemp[i]) == T) { 
    clostriduim.filter$avg.meantemp[i] = mean(clostriduim.filter$avg.maxtemp[i], clostriduim.filter$avg.mintemp[i])}
  if (is.na(clostriduim.filter$avg.lagmeantemp[i]) == T) { 
    clostriduim.filter$avg.lagmeantemp[i] = mean(clostriduim.filter$avg.lagmaxtemp[i], clostriduim.filter$avg.lagmintemp[i])}
  if (is.na(clostriduim.filter$avg.snow[i]) == T) { 
    clostriduim.filter$avg.snow[i] <- 0}
  if (is.na(clostriduim.filter$avg.lagsnow[i]) == T) { 
    clostriduim.filter$avg.lagsnow[i] <- 0}
  if (is.na(clostriduim.filter$avg.snowdepth[i]) == T) {
    clostriduim.filter$avg.snowdepth[i] <- 0}
  if (is.na(clostriduim.filter$avg.lagsdepth[i]) == T) {
    clostriduim.filter$avg.lagsdepth[i] <- 0}
}

write.csv(clostriduim.filter, 'clostriduim_cdc_weather.csv')

# creating the training and test sets 
test <- sample(1:nrow(clostriduim.filter), nrow(clostriduim.filter)/4) # taking a 1/4 of the data out for testing the model 
train <- (-test)
clostriduim.train.x <- as.matrix(clostriduim.filter[train, -4])
clostriduim.train.y <- as.matrix(clostriduim.filter[train, 'total.illnesses'])
clostriduim.test.x <- as.matrix(clostriduim.filter[test, -4])
clostriduim.test.y <- as.matrix(clostriduim.filter[test, 'total.illnesses'])

# applying the LASSO model to see which variables are significant 
clostriduim.lasso.mod <- glmnet(clostriduim.train.x, clostriduim.train.y, alpha = 1)
plot(clostriduim.lasso.mod)
# performing cross validation to compute test error and to perform variable selection 
clostriduim.cv <- cv.glmnet(clostriduim.train.x, clostriduim.train.y, alpha = 1)
plot(clostriduim.cv)
# getting the lambda value with the lowest MSE 
bestlam3 <- clostriduim.cv$lambda.min
clostriduim.lasso.pred <- predict(clostriduim.lasso.mod, s = bestlam3, newx = clostriduim.test.x)
mean((clostriduim.lasso.pred - clostriduim.test.y)^2)
# looking at the LASSO coefficients to find the values coefficient values are 0 and thus not siginificant to the model prediction 
# fitting the LASSO regression using the best lambda value to determine variable selection 
clostriduim.filter <- as.matrix(clostriduim.filter)
full.clostriduim.lasso.mod <- glmnet(clostriduim.filter[,-4], clostriduim.filter[, 4], alpha = 1)
clostriduim.lasso.coef <- predict(full.clostriduim.lasso.mod, type = 'coefficients', s = bestlam3)
clostriduim.lasso.coef
clostriduim.lasso.coef[clostriduim.lasso.coef != 0]


```

```{r, include=FALSE}
# performing 10-fold cross validation to assess the fit and quality of the model 
cdc.lasso.optimal <- glmnet(cdc.train.x, cdc.train.y, alpha = 1, lambda = bestlam.cdc)
cdc.lasso.optimal.pred <- predict(cdc.lasso.optimal, newx = cdc.test.x)
mean((cdc.lasso.optimal.pred - cdc.test.y)^2)

```

```{r, echo=FALSE}
# creating a yearmon column to plot timeseries 
cdc.weather$yearmon <- paste0(cdc.weather$year, '-', sprintf('%02d', cdc.weather$month))
cdc.weather$yearmon <- as.yearmon(cdc.weather$yearmon)
# glimpse(cdc.weather)

cdc.weather |> 
  group_by(yearmon, month) |>
  summarise(avgillness = mean(total.illnesses)) |>
  ggplot(aes(x = yearmon, y = avgillness, color = as.factor(month))) + 
  geom_col() + geom_line() + facet_wrap(~month) +
  theme(axis.text.x = element_text(angle = 90), legend.position='none') + labs(title='Average Number of Illnesses over Time for Each Month', x='Average Number of Illnesses', y='Average Number of Illnesses')


scaled.cdc.weather$yearmon <- paste0(scaled.cdc.weather$year, '-', sprintf('%02d', scaled.cdc.weather$month))
scaled.cdc.weather$yearmon <- as.yearmon(scaled.cdc.weather$yearmon)

scaled.cdc.weather <- cbind(cdc.weather[,c(1:3,17)], scale(cdc.weather[,-c(1:3,17)]))
glimpse(scaled.cdc.weather)

scaled.cdc.weather |>
  filter(year <= 2012) |>
  ggplot(aes(x = yearmon)) + 
  geom_line(aes(y=avg.prcp), color = 'blue') + 
  geom_line(aes(y=total.illnesses), color = 'red') + 
  scale_y_continuous(name = 'Total Illnesses', sec.axis = sec_axis(~.*10, name = "Average Precipitation")) +
  labs(x = 'Month - Year')

scaled.cdc.weather |>
  filter(year > 2012) |>
  ggplot(aes(x = yearmon)) + 
  geom_line(aes(y=avg.lagmeantemp), color = 'blue') + 
  geom_line(aes(y=total.illnesses), color = 'red') + 
  scale_y_continuous(name = 'Total Illnesses', sec.axis = sec_axis(~./10, name = "Average Lag in Mean Temperature")) +
  labs(x = 'Month - Year')


scaled.cdc.weather |>
  filter(year <= 2005) |>
  ggplot(aes(x = yearmon)) + 
  geom_line(aes(y=avg.prcp, color = 'blue'))

scaled.cdc.weather |>
  filter(year <= 2005) |>
  ggplot(aes(x = yearmon)) + 
  geom_line(aes(y=total.illnesses, color = 'red')) 



```

```{r}

salmonella.weather$yearmon <- paste0(salmonella.weather$year, '-', sprintf('%02d', salmonella.weather$month))
salmonella.weather$yearmon <- as.yearmon(salmonella.weather$yearmon)

scaled.salmonella <- cbind(salmonella.weather[,c(1:3,17)], scale(salmonella.weather[,-c(1:3,17)]))
#glimpse(scaled.shigella)

cdc.weather |>
  #filter(year <= 2010) |> 
  ggplot(aes(x = as.Date(yearmon))) + 
  geom_col(aes(y=total.illnesses), fill = 'cadetblue3', alpha = 1.0) + 
  geom_col(aes(y=avg.lagmeantemp), fill = 'darkorange', alpha = 0.7) + 
  scale_y_continuous(name = 'Number of Outbreaks', 
                     sec.axis = sec_axis(~./2.5, name = 'Average Lag in Mean Temperature (˚F)')) +
  labs(x = 'Month - Year', title = 'Trend of Reported Illnesses and Average Month to Month Lag in Mean Temperature\n from 2001 to 2021 for Illinois, Iowa, and Wisconsin') + theme(
        axis.text=element_text(size=12),
        axis.title=element_text(size=12),  
        axis.title.y.left=element_text(color='cadetblue3', face='bold'), 
        axis.text.y = element_text(color = 'cadetblue3'),
        axis.title.y.right = element_text(color = 'darkorange', face='bold'),
        axis.text.y.right = element_text(color = 'darkorange'),
        plot.title = element_text(size=14, face='bold'), axis.text.x = element_text(angle = 45, hjust = 1)) + 
  scale_x_date(date_breaks = '18 month',date_labels = "%b-%Y")


cdc.weather |>
  #filter(year <= 2010) |> 
  ggplot(aes(x = as.Date(yearmon))) + 
  geom_col(aes(y=total.illnesses), color = 'royalblue4', alpha = 1.5) +
  geom_col(aes(y=avg.maxtemp), color = 'goldenrod2', alpha = 0.0001) + 
  scale_y_continuous(name = 'Number of Outbreaks', 
                     sec.axis = sec_axis(~./2.7, name = 'Average Max Temperature (˚F)')) +
  labs(x = 'Month - Year', title = 'Trend of Reported Illnesses and Average Max Temperature\n from 2001 to 2021 for Illinois, Iowa, and Wisconsin') + theme(
        axis.text=element_text(size=12),
        axis.title=element_text(size=12),  
        axis.title.y.left=element_text(color='royalblue4', face='bold'), 
        axis.text.y = element_text(color = 'royalblue4'),
        axis.title.y.right = element_text(color = 'goldenrod2', face='bold'),
        axis.text.y.right = element_text(color = 'goldenrod2'),
        plot.title = element_text(size=14, face='bold'), axis.text.x = element_text(angle = 45, hjust = 1)) + 
  scale_x_date(date_breaks = '18 month',date_labels = "%b-%Y")



salmonella.weather |>
  filter(total.illnesses < 600) |> 
  ggplot(aes(x = as.Date(yearmon))) + 
  geom_col(aes(y=avg.lagmaxtemp), fill = 'coral1', alpha = 1.5) + 
  geom_col(aes(y=total.illnesses), fill = 'dodgerblue', alpha = 0.7) + 
  scale_y_continuous(name = 'Number of Outbreaks', 
                     sec.axis = sec_axis(~./2.7, name = 'Lag in Max Temperature (˚F)')) +
  labs(x = 'Month - Year', title = 'Trend of the Number of Salmonella Illnesses and Month to Month\n Lag in Mean Temperature from 2001 to 2021 for Illinois, Iowa, and Wisconsin') + theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12),  
        axis.title.y.left=element_text(color='dodgerblue', face='bold'), 
        axis.text.y = element_text(color = 'dodgerblue'),
        axis.title.y.right = element_text(color = 'coral1', face='bold'),
        axis.text.y.right = element_text(color = 'coral1'),
        plot.title = element_text(size=14, face='bold'), axis.text.x = element_text(angle = 45, hjust = 1)) + 
  scale_x_date(date_breaks = '18 month',date_labels = "%b-%Y")



salmonella.weather |>
  #filter(year <= 2010) |> 
  ggplot(aes(x = yearmon)) + 
  geom_col(aes(y=avg.lagmaxtemp), fill = 'skyblue') + 
  geom_col(aes(y=total.illnesses), fill = 'red') + 
  scale_y_continuous(name = 'Number of Outbreaks', 
                     sec.axis = sec_axis(~./10, name = 'Average Monthly Lag in Max Temperature')) +
  labs(x = 'Month - Year', title = 'Trend of the Number of Salmonella Illnesses from 2001 to 2021')
 
salmonella.weather |>
  #filter(year <= 2010) |> 
  ggplot(aes(x = yearmon)) + 
  geom_col(aes(y=avg.lagprcp), fill = 'skyblue') + 
  geom_col(aes(y=total.illnesses), fill = 'red') + 
  labs(x = 'Month - Year', y = 'Number of Illnesses', title = 'Total Number of Salmonella Illnesses from 2001 to 2021')



scaled.salmonella |>
  filter(year <= 2010) |> 
  ggplot(aes(x = yearmon)) + 
  geom_point(aes(y=avg.lagmeantemp), color = 'skyblue') + 
  geom_line(aes(y=avg.lagmeantemp), color = 'skyblue') +
  geom_point(aes(y=total.illnesses), color = 'red')+ 
  geom_line(aes(y=total.illnesses), color = 'red')

library(dbscan) 
# applying the kmeans elbow method to the snow depth variable 
scaled.prcp <- scaled.salmonella[, c('total.illnesses', 'avg.prcp', 'yearmon')]
scaled.prcp <- na.omit(scaled.prcp)
#glimpse(scaled.snowdepth)

scaled_kmeans <- data.frame(matrix(ncol = 2, nrow = 20))
colnames(scaled_kmeans) <- c('k', 'wi_ss')
for(i in 1:20){ #running from k = 1 to k = 20
  km <- kmeans(scaled.prcp[,1:2], centers = i)
  wi_ss <- round(km$tot.withinss, 3)
  scaled_kmeans[i, 'k'] <- i
  scaled_kmeans[i, 'wi_ss'] <- wi_ss
}
scaled_kmeans |> ggplot(aes(x=k, y=wi_ss)) + geom_line() + geom_point() + labs(title='K-Means Clustering Elbow Method for Number of Illnesses vs. Average Snow Depth in Inches', y='Within Sum of Squares') # 20 clusters offers the lowest total sum of squares value

scaled.kmeans6 <- kmeans(scaled.prcp[,1:2], centers = 9)
kmeans6.clusters <- factor(scaled.kmeans6$cluster)
scaled.prcp$clusters <- kmeans6.clusters

ggplot(scaled.prcp, aes(x = yearmon, y = total.illnesses, color = clusters)) + geom_point() + labs(title='K=20 K-Means Clustering of Total Illnesses vs. Average Snowfall in Inches', x='Number of Illnesses', y='Average Snow Depth (in)')


```

```{r}
# applying the kmeans elbow method to the snow depth variable 
scaled.snow <- scaled.salmonella[, c('total.illnesses', 'avg.snow', 'yearmon')]
scaled.snow <- na.omit(scaled.snow)
#glimpse(scaled.snowdepth)

snow_kmeans <- data.frame(matrix(ncol = 2, nrow = 20))
colnames(scaled_kmeans) <- c('k', 'wi_ss')
for(i in 1:20){ #running from k = 1 to k = 20
  km <- kmeans(scaled.snow[,1:2], centers = i)
  wi_ss <- round(km$tot.withinss, 3)
  snow_kmeans[i, 'k'] <- i
  snow_kmeans[i, 'wi_ss'] <- wi_ss
}
snow_kmeans |> ggplot(aes(x=k, y=wi_ss)) + geom_line() + geom_point() + labs(title='K-Means Clustering Elbow Method for Number of Illnesses vs. Average Snowfall in Inches', y='Within Sum of Squares') # 20 clusters offers the lowest total sum of squares value

scaled.kmeans7 <- kmeans(scaled.snow[,1:2], centers = 8)
kmeans7.clusters <- factor(scaled.kmeans7$cluster)
scaled.snow$clusters <- kmeans7.clusters

ggplot(scaled.snow, aes(x = yearmon, y = total.illnesses, color = clusters)) + geom_point() + labs(title='K=20 K-Means Clustering of Total Illnesses vs. Average Snowfall in Inches', x='Number of Illnesses', y='Average Snowfall (in)')
ggplot(scaled.snow, aes(x = avg.snow, y = total.illnesses, color = clusters)) + geom_point() + labs(title='K=20 K-Means Clustering of Total Illnesses vs. Average Snowfall in Inches', x='Number of Illnesses', y='Average Snowfall (in)')


```

# Regression Decision Tree Fitting
```{r}
# Running a Random Forest
library(tree)
set.seed(2)
sub.salmonella <- salmonella.weather |> select(year, month, avg.prcp, avg.snow, avg.snowdepth, avg.lagmaxtemp, avg.lagprcp, avg.lagsdepth, total.illnesses)
train <- sample(1:nrow(sub.salmonella), (4/5)*nrow(sub.salmonella))
tree.salmonella <- tree(total.illnesses ~ ., sub.salmonella, subset = train)
summary(tree.salmonella)

plot(tree.salmonella)
text(tree.salmonella, pretty= 0)

cv.salmonella <- cv.tree(tree.salmonella)
plot(cv.salmonella$size, cv.salmonella$dev, type = 'b')

yhat <- predict(tree.salmonella, newdata = sub.salmonella[-train, ])
salmonella.test <- sub.salmonella[-train, 'total.illnesses']
yhat <- data.frame(yhat)
square.error <- (yhat$yhat - salmonella.test$total.illnesses)^2
sqrt(mean(square.error, na.rm=TRUE))

prune.salmonella <- prune.tree(tree.salmonella, best = 4)
plot(prune.salmonella)
text(prune.salmonella, pretty = 0)
summary(prune.salmonella)

yhat2 <- predict(prune.salmonella, newdata = sub.salmonella[-train, ])
yhat2 <- data.frame(yhat2)
plot(yhat2$yhat2, salmonella.test$total.illnesses)
abline(0,1)
square.error <- (yhat2$yhat2 - salmonella.test$total.illnesses)^2
sqrt(mean(square.error, na.rm=TRUE))

cv.salmonella2 <- cv.tree(prune.salmonella)
plot(cv.salmonella2$size, cv.salmonella2$dev, type = 'b')

library(rpart.plot)
#rpart.plot(prune.salmonella)

library(randomForest)
set.seed(1)
#rf.salmonella <- randomForest(total.illnesses ~ ., data = salmonella.weather, subset=train, mtry=6, importance=TRUE)
#yhat.rf <- predict(rf.salmonella, newdata = salmonella.weather[-train, ])
#mean((yhat.rf - salmonella.test$total.illnesses)^2, na.rm=TRUE)

```

```{r}
salmonella.weather |> 
  filter(total.illnesses < 500) |>
  ggplot(aes(x=avg.lagmaxtemp, y=total.illnesses, color=state)) + 
  geom_point() + geom_smooth(method='lm') + facet_wrap(~state) + 
  labs(x='Lag in Max Temperature (˚F)', y='Number of Illnesses', title='Distribution of Average Lag in Max Temperature vs. Number of Illnesses for Each State')

salmonella.weather |> 
  filter(total.illnesses < 500) |>
  ggplot(aes(x=avg.lagprcp, y=total.illnesses, color=state)) + 
  geom_point(shape = 19, size = 0.9) + geom_smooth(method='lm') + facet_wrap(~state) + 
  labs(x='Lag in Precipitation (in)', y='Number of Illnesses', title='Distribution of Lag in Monthly Precipitation vs. Number of Illnesses for Each State') + 
  theme(axis.text = element_text(size = 10), axis.title = element_text(size = 10), legend.text = element_text(size=10), legend.position = "none", title = element_text(face='bold', size = 10))

salmonella.weather |> 
  filter(total.illnesses < 500) |>
  ggplot(aes(x=avg.prcp, y=total.illnesses, color=state)) + 
  geom_point(shape = 19, size = 0.9) + geom_smooth(method='lm') + facet_wrap(~state)

```
